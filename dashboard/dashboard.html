<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Industrial</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeDrawer()"></div>

    <!-- PANEL LATERAL IZQUIERDO (Detalles) -->
    <div class="details-drawer" id="sensorDrawer">
        <div class="drawer-header">
            <h2 id="drawerTitle">Sensor X</h2>
            <button class="close-btn" onclick="closeDrawer()">
                <!-- Icono de cerrar con tu asset -->
                <img src="sensor_close.png" class="icon-btn" alt="Cerrar">
            </button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <!-- Aquí se inyectan las alertas específicas -->
        </div>
    </div>

    <div class="main-layout">
        <div class="dashboard-content">
            <h1>Monitor de Sensores en Tiempo Real</h1>
            
            <div class="filters-container">
                <img src="filter.png" alt="Filtrar" class="filter-icon">
                <label for="sortFilter">Ordenar por: </label>
                <select id="sortFilter" onchange="updateUI()">
                    <option value="alpha">Alfabético (A-Z)</option>
                    <option value="total_problems">Mayor N° Total de Problemas</option>
                    <option value="most_critical">Mayor N° Críticas</option>
                    <option value="most_warning">Mayor N° Advertencias</option>
                </select>
            </div>
            
            <div class="sensors-grid" id="sensorsGrid">
            </div>
        </div>

        <aside class="stats-sidebar">
            <div class="stat-box">
                <span class="stat-title">Mayor número de problemas:</span>
                <span class="stat-value-big" id="statWorstSensor">-</span>
            </div>

            <div class="stat-box">
                <span class="stat-title">Total de Advertencias:</span>
                <span class="stat-value-medium" id="statTotalWarnings">0</span>
            </div>

            <div class="stat-box">
                <span class="stat-title">Total Alertas Críticas:</span>
                <span class="stat-value-medium" id="statTotalCritical">0</span>
            </div>
            
            <div class="stat-box" style="margin-top: auto;">
                <span class="stat-title">Estado del Sistema</span>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <small>WS 8081: <span id="dot8081">●</span></small>
                    <small>WS 8082: <span id="dot8082">●</span></small>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const ACTION_DISPATCHER_URL = "http://localhost:8080/decide";
        let sensorsState = {};
        let currentOpenSensor = null;

        function initSensors() {
            const ids = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            ids.forEach(id => {
                const key = `sensor_${id}`;
                sensorsState[key] = {
                    id: key,
                    letter: id,
                    status: 'OPERATIONAL',
                    alerts: []
                };
            });
            updateUI();
        }

        function updateUI() {
            renderGrid();
            renderGlobalStats();
            if (currentOpenSensor) {
                renderDrawerContent(currentOpenSensor);
            }
        }

        function getSensorStats(alerts) {
            let critical = 0;
            let warning = 0;
            alerts.forEach(a => a.type === 'CRITICAL' ? critical++ : warning++);
            return { critical, warning, total: alerts.length };
        }

        function renderGrid() {
            const grid = document.getElementById('sensorsGrid');
            grid.innerHTML = "";

            let sensorsArray = Object.values(sensorsState);
            const sortType = document.getElementById('sortFilter').value;

            sensorsArray.sort((a, b) => {
                const statsA = getSensorStats(a.alerts);
                const statsB = getSensorStats(b.alerts);

                if (sortType === 'total_problems') {
                    return statsB.total - statsA.total;
                } else if (sortType === 'most_critical') {
                    return statsB.critical - statsA.critical;
                } else if (sortType === 'most_warning') {
                    return statsB.warning - statsA.warning;
                } else {
                    return a.letter.localeCompare(b.letter);
                }
            });

            sensorsArray.forEach(sensor => {
                let crit = 0, warn = 0;
                sensor.alerts.forEach(a => a.type === 'CRITICAL' ? crit++ : warn++);

                let statusClass = 'ok';
                if (crit > 0) statusClass = 'crit';
                else if (warn > 0) statusClass = 'warn';

                const card = document.createElement('div');
                card.className = 'sensor-card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="sensor-id-big">${sensor.letter}</span>
                        <div class="mini-stats">
                            <div><img src="warning-icon.png" class="mini-icon"> ${warn}</div>
                            <div><img src="critical-icon.png" class="mini-icon"> ${crit}</div>
                            <div class="status-icon ${statusClass}"></div>
                        </div>
                    </div>
                    <button class="view-details-btn" onclick="openDrawer('${sensor.id}')">
                        <!-- IMAGEN AGREGADA PARA ABRIR -->
                        <img src="sensor_open.png" class="icon-btn-small" alt="Abrir">
                        Ver detalles
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        function renderGlobalStats() {
            let totalWarn = 0;
            let totalCrit = 0;
            let worstSensor = "-";
            let maxProblems = -1;

            Object.values(sensorsState).forEach(sensor => {
                let crit = 0, warn = 0;
                sensor.alerts.forEach(a => a.type === 'CRITICAL' ? crit++ : warn++);
                
                totalWarn += warn;
                totalCrit += crit;
                
                const totalProblems = crit + warn;
                if (totalProblems > maxProblems && totalProblems > 0) {
                    maxProblems = totalProblems;
                    worstSensor = sensor.letter;
                }
            });

            document.getElementById('statTotalWarnings').textContent = totalWarn;
            document.getElementById('statTotalCritical').textContent = totalCrit;
            document.getElementById('statWorstSensor').textContent = worstSensor;
        }

        window.openDrawer = (sensorId) => {
            currentOpenSensor = sensorId;
            document.getElementById('sensorDrawer').classList.add('open');
            document.getElementById('overlay').classList.add('active');
            renderDrawerContent(sensorId);
        };

        window.closeDrawer = () => {
            currentOpenSensor = null;
            document.getElementById('sensorDrawer').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        };

        function renderDrawerContent(sensorId) {
            const sensor = sensorsState[sensorId];
            document.getElementById('drawerTitle').textContent = `Sensor ${sensor.letter}`;
            const content = document.getElementById('drawerContent');
            content.innerHTML = "";

            if (sensor.alerts.length === 0) {
                content.innerHTML = "<p>Sin alertas activas.</p>";
                return;
            }

            sensor.alerts.forEach(alert => {
                const div = document.createElement('div');
                div.className = `alert-item type-${alert.type}`;
                
                div.innerHTML = `
                    <strong>${alert.type}</strong>
                    <div style="font-size: 1.2em; margin: 5px 0;">
                        Vibración: <strong>${alert.vibration}</strong>
                    </div>
                    <small style="opacity: 0.7;">ID: ${alert.alert_id.substring(0, 8)}...</small>
                    <div id="btns-${alert.alert_id}"></div>
                `;
                
                const btnContainer = div.querySelector(`#btns-${alert.alert_id}`);
                alert.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = opt.replaceAll('_', ' ');
                    btn.onclick = () => sendDecision(alert, opt);
                    btnContainer.appendChild(btn);
                });

                content.appendChild(div);
            });
        }

        async function sendDecision(alertObject, action) {
            try {
                const response = await fetch(ACTION_DISPATCHER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ alert: alertObject, chosen_action: action })
                });

                if (response.ok) {
                    sensorsState[alertObject.sensor_id].alerts = sensorsState[alertObject.sensor_id].alerts.filter(a => a.alert_id !== alertObject.alert_id);
                    updateUI();
                }
            } catch (e) {
                alert("Error de conexión");
            }
        }

        function setupWebSocket(url, type) {
            const ws = new WebSocket(url);
            ws.onopen = () => {
                const dot = url.includes('8081') ? 'dot8081' : 'dot8082';
                document.getElementById(dot).style.color = 'green';
            };
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (type === 'status') handlePlantState(data);
                    if (type === 'action') handleNewAlert(data);
                } catch(e) {}
            };
            ws.onclose = () => {
                 setTimeout(() => setupWebSocket(url, type), 3000);
                 const dot = url.includes('8081') ? 'dot8081' : 'dot8082';
                 document.getElementById(dot).style.color = 'red';
            };
        }

        function handlePlantState(data) {}

        function handleNewAlert(data) {
            const sensorKey = `sensor_${data.sensor_id.replace('sensor_', '')}`;
            if (sensorsState[sensorKey]) {
                const exists = sensorsState[sensorKey].alerts.some(a => a.alert_id === data.alert_id);
                if (!exists) {
                    sensorsState[sensorKey].alerts.unshift(data);
                    updateUI();
                }
            }
        }

        initSensors();
        setupWebSocket("ws://localhost:8081/ws", 'status');
        setupWebSocket("ws://localhost:8082/ws", 'action');
    </script>
</body>
</html>